@model ECommerceApp.Application.ViewModels.Order.NewOrderVm

@{
    ViewData["Title"] = "EditOrder";
}

<div>
    <h1>Edycja zamówienia</h1>

    <hr />
    <div class="row d-flex flex-column">
        <div>
            <form id="EditOrderForm" asp-action="EditOrder">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                <input data-name="Id" type="hidden" asp-for="Id" class="form-control" />
                <input type="hidden" asp-for="UserId" class="form-control" />
                <div class="form-group">
                    <label style="display:none;" asp-for="Number" class="control-label"></label>
                    <label class="control-label">Numer zamówienia</label>
                    <input readonly asp-for="Number" class="form-control" />
                    <span asp-validation-for="Number" class="text-danger"></span>
                </div>
                <div style="display:none;" class="form-group">
                    <label style="display:none;" asp-for="Cost" class="control-label"></label>
                    <label class="control-label">Koszt do zapłaty</label>
                    <input asp-for="Cost" class="form-control" />
                    <span asp-validation-for="Cost" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label style="display:none;" asp-for="Ordered" class="control-label"></label>
                    <label class="control-label">Zamówiono dnia o godzinie</label>
                    <input readonly asp-for="Ordered" class="form-control" />
                    <span asp-validation-for="Ordered" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label style="display:none;" asp-for="Delivered" class="control-label"></label>
                    <label class="control-label">Dostarczono dnia o godzinie</label>
                    <input asp-for="Delivered" class="form-control" />
                    <span asp-validation-for="Delivered" class="text-danger"></span>
                </div>
                <div class="form-group form-check">
                    <label class="form-check-label">
                        <input style="display:none;" class="form-check-input" asp-for="IsDelivered" onclick="return false;" />
                        <input class="form-check-input" asp-for="IsDelivered" /> Dostarczono
                    </label>
                </div>
                <div style="display:none;" class="form-group">
                    <label asp-for="CouponUsedId" class="control-label"></label>
                    <input asp-for="CouponUsedId" class="form-control" /> <!-- select list or js check if it is correct refcode-->
                    <span asp-validation-for="CouponUsedId" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label style="display:none;" asp-for="CustomerId" class="control-label"></label>
                    <label class="control-label">Klient:</label>
                    <input value="@Model.CustomerInformation" class="form-control" readonly />
                    <input type="hidden" asp-for="CustomerId" class="form-control" />
                    <span asp-validation-for="CustomerId" class="text-danger"></span>
                </div>
                @if (Model.PaymentId > 0)
                {
                    <div class="form-group">
                        <label style="display:none;" asp-for="PaymentId" class="control-label"></label>
                        <label class="control-label">Nr płatności</label>
                        <input readonly value="@Model.PaymentNumber" class="form-control" />
                        <input type="hidden" asp-for="PaymentId" class="form-control" />
                        <span asp-validation-for="PaymentId" class="text-danger"></span>
                    </div>
                    <div class="form-group form-check">
                        <label class="form-check-label">
                            <input type="checkbox" class="form-check-input" asp-for="IsPaid" onclick="return false;" /> Zapłacono
                        </label>
                    </div>
                    @if (Model.RefundId > 0)
                    {
                        <p>Naciśnij przycisk, w celu zmiany zwrotu</p>

                        <button type="button" class="btn btn-info" onclick="ToggleRefund()">Wprowadź/Anuluj</button>
                        <div id="RefundEnter" style="top:50px;">
                            <div class="form-group">
                                <label asp-for="RefundId" class="control-label">Powód zwrotu</label>
                                <input type="hidden" readonly asp-for="RefundId" class="form-control" />
                                <input type="text" id="ReasonRefundText" asp-for="ReasonRefund" class="form-control" />
                                <span asp-validation-for="ReasonRefund" class="text-danger"></span>
                            </div>
                            <div class="form-group form-check">
                                <label class="form-check-label">
                                    <input class="form-check-input" id="AcceptedRefundChoice" asp-for="AcceptedRefund" /> Akceptacja zwrotu
                                </label>
                            </div>
                            <div class="form-group form-check">
                                <label class="form-check-label">
                                    <input class="form-check-input" id="OnWarrantyChoice" asp-for="OnWarranty" /> Na gwarancji
                                </label>
                            </div>
                        </div>
                    }
                    else
                    {
                        <p>Naciśnij przycisk, w celu wprowadzenia zwrotu</p>

                        <button type="button" class="btn btn-info" onclick="ToggleRefund()">Wprowadź/Anuluj</button>
                        <div id="RefundEnter" style="display:none;top:50px;">
                            <div class="form-group">
                                <label asp-for="RefundId" class="control-label">Powód zwrotu</label>
                                <input type="hidden" readonly asp-for="RefundId" class="form-control" />
                                <input type="text" id="ReasonRefundText" asp-for="ReasonRefund" class="form-control" />
                                <span asp-validation-for="RefundId" class="text-danger"></span>
                            </div>
                            <div class="form-group form-check">
                                <label class="form-check-label">
                                    <input class="form-check-input" id="AcceptedRefundChoice" asp-for="AcceptedRefund" /> Akceptacja zwrotu
                                </label>
                            </div>
                            <div class="form-group form-check">
                                <label class="form-check-label">
                                    <input class="form-check-input" id="OnWarrantyChoice" asp-for="OnWarranty" /> Na gwarancji
                                </label>
                            </div>
                        </div>
                    }
                }
                <div class="mt-2 mb-2">
                    <label>Kod promocyjny</label>
                    <input id="RefCode" type="text" asp-for="Discount" value="@Model.Discount" class="form-control" />
                    <span asp-validation-for="Discount" class="text-danger"></span>
                </div>
                <div class="mb-2 mt-2">
                    <p>Przedmioty:</p>
                    <table id="itemWithJS">
                        @for (int i = 0; i < Model.OrderItems.Count; i++)
                        {
                            <tr id="@i">
                                <td>
                                    <input name="Item" value="@Model.OrderItems[i].ItemName" class="form-control valid" readonly style="width: 250px;position:static; " />
                                    <input id="itemId" type="hidden" name="OrderItems[@i].ItemId" value="@Model.OrderItems[i].ItemId" class="col-sm-2 col-form-label" />
                                    <input id="orderId" type="hidden" name="OrderItems[@i].OrderId" class="form-control" value="@Model.Id" />
                                    <input id="orderItemId" type="hidden" name="OrderItems[@i].Id" class="form-control" value="@Model.OrderItems[i].Id" />
                                </td>
                                <td>
                                    <a><i id="OrderItems[@i].ItemOrderQuantity" class="fas fa-plus-circle ml-2 fa_custom add-quantity"></i></a>
                                    <input id="ItemQuantity[@i]" name="OrderItems[@i].ItemOrderQuantity" value="@Model.OrderItems[i].ItemOrderQuantity" readonly style="width: 45px; display: inline !important; margin-left: 4px; margin-right: 4px;" class="form-control" />
                                    <a><i class="fa fa-minus-circle fa_custom remove-quantity" style="margin-right: 4px" id="OrderItems[@i].ItemOrderQuantity"></i></a>
                                    <button id="@i" type="button" class="btn btn-danger delete">Usuń</button>
                                </td>
                            </tr>
                        }
                    </table>
                </div>
                <div>
                    <select id="Items" name="Items" asp-items="@(new SelectList(Model.Items,"Id", "Name"))" class="custom-select" data-val="true"></select>
                    <button type="button" id="add" class="btn btn-info">Wybierz przedmiot</button>
                    <select id="ItemsWithCosts" style="display:none;" name="ItemsCost" asp-items="@(new SelectList(Model.Items, "Id", "Cost"))" class="custom-select"></select>
                </div>
                <table id="RefreshCost">
                    <tr>
                        @if (Model.CustomerId > 0)
                        {
                            <td>
                                Cena: <input id="CalcCost" name="CostToConvert" value="@Model.Cost" readonly style="width: 250px;position:static; " class="form-control" />
                            </td>
                        }
                    </tr>
                </table>
                <div class="form-group">
                    <input type="submit" value="Zatwierdź" class="btn btn-primary" />
                </div>
            </form>
        </div>
    </div>
    <div class="form-group">
            <a asp-controller="Item" asp-action="Index">Wróć do listy przedmiotów</a>
        @if (!Model.IsPaid)
        {
            @(" | ")<a asp-controller="Payment" asp-action="AddPayment" asp-route-id="@Model.Id">Przejdź do płatności</a>
        }
    </div>
</div>

@section Scripts {
    <script>
        let orderItems = [];
        const orderId = document.querySelector('[data-name="Id"]').value;
        const itemCosts = [];
        const format = (num, decimals) => num.toLocaleString('pl-PL', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
        });

        var table = $('#itemWithJS');
        var itemsSelector = document.getElementById("Items");
        var selectedIndex;
        var selectedValue;

        $(document).ready(function () {
            initView();
        });

        $('#add').click(function () {
            const tableRows = $('#itemWithJS tr');
            const elements = $('#itemWithJS tr').length;
            selectedIndex = itemsSelector.options[itemsSelector.selectedIndex].index;
            selectedValue = itemsSelector.options[itemsSelector.selectedIndex].value;
            selectedText = itemsSelector.options[itemsSelector.selectedIndex].text;
            const orderItem = { name: selectedText, itemId: selectedValue, orderId, orderItemId: 0, quantity: 1 }
            orderItems.push(orderItem);
            const row = createOrderItemRow(orderItem, elements);
            table.append(row);
            if (selectedIndex > -1) {
                itemsSelector.remove(selectedIndex);
            }
            calculateCosts();
            selectedIndex = 0;
        });

        $(document).on('change', 'select', function () {
            selectedIndex = (this).index;
            selectedValue = (this).value;
            var collectionInSelectList = this.children;

            for (i = 0; i < collectionInSelectList.length; i++) {
                if (collectionInSelectList[i].value == selectedValue) {
                    selectedIndex = i;

                }
            }
        });

        $('#itemWithJS').on('click', '.delete', async function () {
            const selectedTableRow = (this).attributes.id.value;
            const orderItem = orderItems[selectedTableRow];
            await DeleteOrderItem(orderItem.orderItemId);
        });

        $('#itemWithJS').on('click', '.add-quantity', function () {
            const index = this.id.replace('OrderItems[', '').split(']')[0];
            const quantityElement = this.parentNode.parentNode.querySelector('[id="ItemQuantity[' + index + ']"]');
            orderItems[index].quantity += 1;
            quantityElement.value = orderItems[index].quantity;
            calculateCosts();
        });

        $('#itemWithJS').on('click', '.remove-quantity', function () {
            const index = this.id.replace('OrderItems[', '').split(']')[0];
            const quantityElement = this.parentNode.parentNode.querySelector('[id="ItemQuantity[' + index + ']"]');
            if (orderItems[index].quantity === 1) {
                return;
            }

            orderItems[index].quantity -= 1;
            quantityElement.value = orderItems[index].quantity;
            calculateCosts();
        });

        function initView() {
            initOrderItems();
            initItemCosts();
            calculateCosts();
        }

        function calculateCosts() {
            let cost = 0;
            for (const orderItem of orderItems) {
                const itemCost = itemCosts.find(i => i.itemId === orderItem.itemId);
                cost += Number(itemCost?.cost ?? 0) * orderItem.quantity;
            }
            cost = format(cost);
            document.getElementById('CalcCost').value = cost;
        }

        function initItemCosts() {
            var itemsCostWithIds = document.getElementById('ItemsWithCosts').options;
            for (const item of itemsCostWithIds) {
                itemCosts.push({ itemId: item.value, cost: Number(item.textContent.replace(",", ".")) });
            }
            for (let i = itemsSelector.options.length - 1; i >= 0; i--) {
                const orderItemExists = orderItems.find(oi => oi.itemId === itemsSelector[i].value);
                if (!orderItemExists) {
                    continue;
                }
                itemsSelector.remove(i);
            }
        }

        function initOrderItems() {
            const tableRows = $('#itemWithJS tr');
            if (tableRows.length === 0) {
                return;
            }

            for (let i = 0; i < tableRows.length; i++) {
                const name = tableRows[i].querySelector('[name="Item"]').value;
                const itemId = tableRows[i].querySelector('#itemId').value;
                const orderId = tableRows[i].querySelector('#orderId').value;
                const orderItemId = tableRows[i].querySelector('#orderItemId').value;
                const quantity = Number(tableRows[i]?.querySelector('[id="ItemQuantity[' + i + ']"]')?.value ?? 0);
                orderItems.push({ name, itemId, orderId, orderItemId, quantity });
            }
        }

        function createOrderItemRow(orderItem, index) {
            const row = document.createElement('tr');
            const dataTag = document.createElement('td');

            const itemNameInput = document.createElement('input');
            itemNameInput.name = "Item";
            itemNameInput.value = orderItem.name;
            itemNameInput.className = "form-control valid";
            itemNameInput.readOnly = true;
            itemNameInput.style = "width: 250px;position:static;";
            dataTag.appendChild(itemNameInput);

            const itemIdInput = document.createElement('input');
            itemIdInput.value = orderItem.itemId;
            itemIdInput.setAttribute("id", "itemId");
            itemIdInput.type = "hidden";
            itemIdInput.name = "OrderItems[" + index + "].ItemId";
            dataTag.appendChild(itemIdInput);

            const orderIdInput = document.createElement('input');
            orderIdInput.value = orderItem.orderId
            orderIdInput.setAttribute("id", "orderId");
            orderIdInput.type = "hidden";
            orderIdInput.name = "OrderItems[" + index + "].OrderId";
            dataTag.appendChild(orderIdInput);

            const idInput = document.createElement('input');
            idInput.value = document.querySelector('[data-name="Id"]')?.value ?? 0;
            idInput.setAttribute("id", "orderItemId");
            idInput.type = "hidden";
            idInput.name = "OrderItems[" + index + "].Id";
            dataTag.appendChild(idInput);

            const dataButton = document.createElement('td');
            const addQuantityAnchor = document.createElement('a');
            const addIcon = document.createElement('i');
            addIcon.setAttribute("id", "OrderItems[" + index + "].ItemOrderQuantity");
            addIcon.className = "fas fa-plus-circle ml-2 fa_custom add-quantity";
            addQuantityAnchor.appendChild(addIcon);
            const inputQuantity = document.createElement('input');
            inputQuantity.setAttribute("id", "ItemQuantity[" + index + "]");
            inputQuantity.name = "OrderItems[" + index + "].ItemOrderQuantity";
            inputQuantity.setAttribute("readonly", true);
            inputQuantity.style = "width: 45px; display: inline !important";
            inputQuantity.className = "form-control ml-2 mr-2";
            inputQuantity.value = orderItem.quantity;
            const deleteQuantityAnchor = document.createElement('a');
            const deleteIcon = document.createElement('i');
            deleteIcon.setAttribute("id", "OrderItems[" + index + "].ItemOrderQuantity");
            deleteIcon.className = "fas fa-minus-circle mr-2 fa_custom remove-quantity";
            deleteQuantityAnchor.appendChild(deleteIcon);
            const button = buttonTemplate.createButton('Usuń', 'btn btn-danger delete', undefined, 'button', [{ key: "id", value: index }]);
            button.id = index;
            dataButton.id = "buttonDelete";
            dataButton.style = "position:relative; top:0px;"
            dataButton.appendChild(addQuantityAnchor);
            dataButton.appendChild(inputQuantity);
            dataButton.appendChild(deleteQuantityAnchor);
            dataButton.appendChild(button);

            row.appendChild(dataTag);
            row.appendChild(dataButton);
            return row;
        }

        async function DeleteOrderItem(id) {
            var orderItemId = parseInt(id);
            var url = '/OrderItem/DeleteOrderItem/' + orderItemId;
            try {
                const response = await fetch(url, {
                    method: 'DELETE',
                });

                if (response.ok) {
                    window.location.reload();
                }
                let responseText = await response.text();

                resultElement.value = 'Result: ' + response.status + ' ' +
                    response.statusText + ' ' + responseText;
                console.log(responseText);
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function ToggleRefund() {
            var x = document.getElementById("RefundEnter");
            if (x.style.display === "none") {
                x.style.display = "block";
            } else {
                x.style.display = "none";
                document.getElementById("ReasonRefundText").value = "";
                document.getElementById("AcceptedRefundChoice").checked = false;
                document.getElementById("OnWarrantyChoice").checked = false;
            }
        }

    </script>
    <style type="text/css">
        .fa_custom {
            color: #0077cc;
            cursor: pointer;
        }
    </style>
}
